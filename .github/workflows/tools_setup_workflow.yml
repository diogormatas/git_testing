name: Tools Setup Workflow

# Trigger manual
# on:
#   workflow_dispatch:   

on:
  push:
    branches:
      - development
      - master
      
  pull_request_review:
    types:
      - approved

env:
  DEV_CONNECTION_STRING: "string_de_dev"
  UAT_CONNECTION_STRING: "string_de_uat"
  PROD_CONNECTION_STRING: "string_de_prod"

jobs:
  tool-setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Deploy to environment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            echo "Code merged from FEATURE to DEVELOPMENT branch: Deploying to UAT environment with connection string $UAT_CONNECTION_STRING"
            python tool_setup.py --connection-string $UAT_CONNECTION_STRING            
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "Code merged from DEVELOPMENT to MASTER branch: Deploying to prod environment with connection string $PROD_CONNECTION_STRING"
            python tool_setup.py --connection-string $PROD_CONNECTION_STRING
          fi
          
  tool-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest
